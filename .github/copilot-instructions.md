# Copilot / AI Agent Instructions — social-influence

Summary
- Purpose: A Flask-based web study that presents news articles (from `articles.csv`) to participants, collects questionnaire data, and stores it in a local SQLite database (`instance/responses.db`).
- Quick run (dev):
  - Create venv, install requirements, run the app with Flask or Gunicorn (see README.md)
  - Simulate a participant by adding `?PROLIFIC_PID=<id>` to the URL.

Architecture & Big Picture
- App: `app.py` is the single Flask WSGI app. It defines routes, session flow, and the DB models (Participant, Round).
- Data: `articles.csv` drives the article content. It is read into a Pandas DataFrame (`df = pd.read_csv('articles.csv')`) and `df.reset_index(inplace=True)` gives each article an `index` ID used throughout the app.
- Persistence: SQLite with Flask-SQLAlchemy (`instance/responses.db`). Participant, Round models use JSON columns to store questionnaire data.
- UI: The templates are under `templates/` and use Bootstrap. Images/labels sit in `static/images/`.
- Optional: `NewsCatcherAPI.py` exists to fetch articles from the NewsCatcher API and can be re-run to regenerate `articles.csv` (requires `NEWS_API_KEY` set in env or `.env`).

Important Files & Directories (keep these in mind)
- `app.py` — main code; attach new logic here; `update_participant_data` does most saves.
- `NewsCatcherAPI.py` — script to regenerate `articles.csv` (> set NEWS_API_KEY in env before running).
- `articles.csv` — article dataset. Keep column names: `Category`, `Title`, `Image URL`, `Article URL`, `Content`, `News Provider`.
- `templates/*` — all UI. Link server names to data in `app.py` (fields, session keys).
- `static/images/*` — label images referenced in templates: `itsCOLOUR.png`, `itsBW.png`, `imagetrustscoreCOLOUR.png`, `imagetrustscoreBW.png`, `cr_logo.png`, `cr1.png..cr4.png`.
- `instance/responses.db` — SQLite DB (binary). Use `sqlite3` or `flask shell` to inspect.

Core project flows (what agents need to know)
- Participant flow (session-managed): `landing` -> `demographics` -> `pre_questionnaire` -> `select_article` -> `article` -> `mid_questionnaire` -> `post_questionnaire` -> `thank_you`.
- Session keys used widely: `prolific_id`, `condition`, `round`, `theme_articles`, `seen_article_ids`, `recommendations_meta`, `current_recommendations`, `select_article_completed`, `article_completed`, `mid_questionnaire_completed`, `post_questionnaire_completed`, `last_article_had_label`.
- Condition assignment: By default, `update_participant_data` assigns one of the four conditions  — `['color','no_color','c2pa','nolabel']` — in a round-robin fashion based on the current number of participants. For testing, `GET /set-condition/<cond>` accepts one of these strings.
- Label behavior: `condition` controls the presence and form of visual labels on articles and recommendations. Templates check for `condition` and session values to show label imagery and explanatory collapsible text.

Testing & Debugging guidance (specific commands)
- Setup & Run (local dev):
```bash
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
# create DB schema (run once)
python -c "from app import db; db.create_all()"
# Run dev server
flask --app app run --debug
# Or run directly
python app.py
```
- Test a participant flow in your browser: add `?PROLIFIC_PID=test123` to the URL, e.g. `http://127.0.0.1:5000/?PROLIFIC_PID=test123`.
- Create / refresh `articles.csv` with a NewsCatcher API key:
```bash
export NEWS_API_KEY="<your_key>"
python NewsCatcherAPI.py
```
- Reset DB content (use with caution): GET `/reset-db` route clears Participant and Round rows.
- Force a condition for debugging: visit `/set-condition/color?PROLIFIC_PID=test123`.
- Inspect DB with sqlite3: `sqlite3 instance/responses.db` and `SELECT * FROM participant;`

Conventions & Project-specific Patterns
- Data model: Participant and Round store semi-structured data in `JSON` columns — if you add a new questionnaire field, update `update_participant_data` to persist it.
- Article IDs: `index` column is generated by `df.reset_index(inplace=True)` — do not rely on `Title` or `Article URL` as unique keys, use `index` in session and DB.
- Session-first flow: Most route handlers depend on `session` and use the `require_previous_step` decorator to guard navigation order. When adding a new step, check the decorator usage and session keys (e.g., `session['round']`).
- Templates and POST fields: Ensure `name` attributes and hidden fields match the keys expected by `app.py` (e.g., `selected_article_id`, `label_explained`, `chosen_elements`, `trust_article`).
- Label meta logic: Recommendations use `recommendations_meta` in session to store label visibility per recommended article ID — preserve this when refactoring.

Integration & External Dependencies
- Pandas (local CSV lookup) — no heavy DB for article content.
- NewsCatcher API optional script for generating the dataset: set env `NEWS_API_KEY`, `python NewsCatcherAPI.py`.
- SQLite with SQLAlchemy — no migrations set up; use `db.create_all()` or a migration tool if you add structural schema changes.

Pitfalls & Things to Watch
- The app relies on `PROLIFIC_PID` query param to be set. Without it, visitors are redirected to the landing page.
- For production replace `app.secret_key` — it is currently `'your_secret_key'`.
- Check `articles.csv` formatting before running — `app.py` expects certain columns (Category/Title/Image URL/Article URL/Content/News Provider) and uses `index` created via `reset_index`.
- `venv` is currently included in the repo — consider excluding it and adding a proper `.gitignore`.

When editing or adding features
- New questionnaire fields: add UI in `templates/*`, add route POST logic in `app.py`, then persist via `update_participant_data` (new keys saved to JSON fields).
- New static assets: Put images in `static/images/` and reference via `url_for('static', filename='images/...')`.
- New routes: Add them to `app.py` with `require_previous_step()` where appropriate to maintain the study flow.

Where to look first when debugging
- `app.py` — main logic and session state; consult `update_participant_data` for storage issues.
- `templates/` — ensure form fields are consistent with backend expectations.
- `instance/responses.db` — use `sqlite3` or `flask shell` to inspect saved JSON.
- `NewsCatcherAPI.py` — run if `articles.csv` needs update.

Example snippets
- Create DB schema:
```bash
python -c "from app import db; db.create_all()"
```
- Start the app with a test Prolific ID:
```bash
PROLIFIC_PID=test123 flask --app app run --debug
# or
flask --app app run --debug & open http://127.0.0.1:5000/?PROLIFIC_PID=test123
```

Questions, Unclear Areas & TODOs
- This repo currently lacks unit tests or a CI configuration. When editing core logic (session flows, DB updates), run manual flows with debug and confirm DB writes.
- If you need to add DB schema migrations, consider adding Alembic/migrations to the repo and updating `README.md` accordingly.

Thanks — ask for clarification if anything’s unclear or you'd like the file tailored for specific agent roles (e.g., content editor vs backend dev).